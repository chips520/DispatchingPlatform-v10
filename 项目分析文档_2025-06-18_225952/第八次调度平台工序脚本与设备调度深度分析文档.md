# SchedAppCore é¡¹ç›®ç¬¬å…«æ¬¡åˆ†ææ–‡æ¡£ï¼šè°ƒåº¦å¹³å°å·¥åºè„šæœ¬ä¸è®¾å¤‡è°ƒåº¦æ·±åº¦åˆ†æ

**åˆ†ææ—¶é—´ï¼š** 2025-06-18 23:46:48  
**åˆ†æèŒƒå›´ï¼š** å·¥åºè„šæœ¬ç¼–å†™ç®¡ç†ã€ç»„åˆå·¥åºè„šæœ¬ã€ç¡¬ä»¶è®¾å¤‡è°ƒåº¦ã€å¤šåè®®é€šä¿¡æ”¯æŒ  
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** ç¬¬å…«æ¬¡åˆ†æ - è°ƒåº¦å¹³å°äº§å“åŒ–åŠŸèƒ½æ·±åº¦ç ”ç©¶  
**é‡ç‚¹å†…å®¹ï¼š** è„šæœ¬å¼•æ“ã€å·¥åºç»„åˆã€AGV/æœºå™¨äººè°ƒåº¦ã€é€šä¿¡åè®®é›†æˆ

---

## 1. å·¥åºè„šæœ¬ç³»ç»Ÿæ¶æ„åˆ†æ

### 1.1 åŠ¨æ€è„šæœ¬æ‰§è¡Œå¼•æ“

SchedAppCoreå®ç°äº†å®Œæ•´çš„åŠ¨æ€è„šæœ¬æ‰§è¡Œå¼•æ“ï¼Œæ”¯æŒC#å’ŒPythonä¸¤ç§è„šæœ¬è¯­è¨€ï¼š

```csharp
/// <summary>
/// åŠ¨æ€è„šæœ¬ç¼–è¯‘æ‰§è¡Œå·¥å…·ç±»
/// æ”¯æŒC#å’ŒPythonä¸¤ç§è„šæœ¬è¯­è¨€
/// </summary>
public static class ScriptExecuteTools
{
    public enum ProgrammingLanguage
    {
        CSharp,
        Python
    }

    /// <summary>
    /// è„šæœ¬ç¼“å­˜å­—å…¸ - æå‡æ‰§è¡Œæ€§èƒ½
    /// </summary>
    public static Dictionary<string, Script<object>> DictScript = new Dictionary<string, Script<object>>();

    /// <summary>
    /// ç»Ÿä¸€è„šæœ¬ç¼–è¯‘æ‰§è¡Œå…¥å£
    /// </summary>
    public static ScriptResult ScriptCompile(string parm, string persistent, string scriptContent, 
        string taskInfo, long unitId, int sendOrCheckType, ProgrammingLanguage language = ProgrammingLanguage.CSharp)
    {
        if (language == ProgrammingLanguage.Python)
            return ExecutePythonScript(parm, persistent, scriptContent, taskInfo);
        else if (language == ProgrammingLanguage.CSharp)
            return ScriptCompileVSecV2(parm, persistent, scriptContent, taskInfo);
        
        return new ScriptResult() { Code = -1, Result = null, Msg = "è„šæœ¬ç±»å‹ä¸æ”¯æŒ" };
    }
}
```

### 1.2 è„šæœ¬ç±»å‹åˆ†ç±»ä½“ç³»

ç³»ç»Ÿæ”¯æŒä¸‰ç§è„šæœ¬æ‰§è¡Œç±»å‹ï¼š

```csharp
/// <summary>
/// æŒ‡ä»¤å†…å®¹ç±»å‹åˆ†ç±»
/// </summary>
int insScript = sendInfo.InstructUnit.ExecuteScriptType;

switch (insScript)
{
    case 0: // ç›´æ¥å†…å®¹å‘é€
        // ç›´æ¥ä½¿ç”¨æŒ‡ä»¤å†…å®¹ä½œä¸ºå‘é€æ•°æ®
        break;
        
    case 1: // C#å‡½æ•°è„šæœ¬åŠ¨æ€ç¼–è¯‘
        scriptResult = ScriptExecuteTools.ScriptCompile(
            lastResult,      // ä¸Šæ¬¡æ‰§è¡Œç»“æœ
            lastPersStr,     // æŒä¹…åŒ–æ•°æ®  
            insContent,      // è„šæœ¬å†…å®¹
            sendInfo.TaskInfo, // ä»»åŠ¡ä¸Šä¸‹æ–‡
            sendInfo.InstructUnit.Id, // æŒ‡ä»¤ID
            0               // æ‰§è¡Œç±»å‹(0=æ‰§è¡Œ, 1=æ ¡éªŒ)
        );
        break;
        
    case 2: // å‰ç½®ç»“æœå†…å®¹ä¼ é€’
        // ä½¿ç”¨å‰ä¸€ä¸ªæŒ‡ä»¤çš„æ‰§è¡Œç»“æœ
        break;
}
```

### 1.3 è„šæœ¬ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼ é€’

è„šæœ¬æ‰§è¡Œæ—¶å¯è®¿é—®ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š

```csharp
/// <summary>
/// è„šæœ¬æ‰§è¡Œä¸Šä¸‹æ–‡å‚æ•°
/// </summary>
public class ScriptExecutionContext
{
    /// <summary>
    /// å‰ä¸€æŒ‡ä»¤æ‰§è¡Œç»“æœ - JSONåºåˆ—åŒ–å­—ç¬¦ä¸²
    /// </summary>
    public string LastResult { get; set; }
    
    /// <summary>
    /// æŒä¹…åŒ–æ•°æ® - è·¨æŒ‡ä»¤æ•°æ®ä¼ é€’
    /// </summary>
    public string PersistentData { get; set; }
    
    /// <summary>
    /// ä»»åŠ¡ä¿¡æ¯ - åŒ…å«å®Œæ•´ä»»åŠ¡ä¸Šä¸‹æ–‡
    /// </summary>
    public string TaskInfo { get; set; }
    
    /// <summary>
    /// è®¾å¤‡ä¿¡æ¯ - åŠ¨æ€æ·»åŠ çš„è®¾å¤‡ç›¸å…³å‚æ•°
    /// </summary>
    public Dictionary<string, object> DeviceInfo { get; set; }
}
```

**TaskInfoä¸­åŒ…å«çš„å…³é”®ä¿¡æ¯**ï¼š
- `taskId` - ä»»åŠ¡ID
- `externalTaskId` - å¤–éƒ¨ä»»åŠ¡ID  
- `taskSubId` - å­ä»»åŠ¡ID
- `mqSampleId` - MQTTæ ·å“ID
- `devCode` - è®¾å¤‡ç¼–ç 
- `coords` - è®¾å¤‡åæ ‡ä¿¡æ¯
- `dir` - è®¾å¤‡æ–¹å‘

---

## 2. å·¥åºç»„åˆç®¡ç†ç³»ç»Ÿ

### 2.1 å·¥åºç»„åˆæ•°æ®æ¨¡å‹

```csharp
/// <summary>
/// æŒ‡ä»¤ç»„åˆè¡¨ï¼ˆå·¥åºï¼‰æ•°æ®å®ä½“
/// </summary>
public class InstructCombinationVo : IDisposable
{
    /// <summary>
    /// ç»„åˆæŒ‡ä»¤ID
    /// </summary>
    public long Id { get; set; }

    /// <summary>
    /// å·¥åºåç§°
    /// </summary>
    public string CombinationName { get; set; }

    /// <summary>
    /// æŒ‡ä»¤å•å…ƒåˆ—è¡¨ - å·¥åºçš„å…·ä½“å®ç°
    /// </summary>
    public List<InstructUnitVo> BList { get; set; }

    /// <summary>
    /// çˆ¶çº§ä»»åŠ¡è°ƒåº¦å¯¹è±¡
    /// </summary>
    public InstructScheduledVo ParentInsScheduled { get; set; }
}
```

### 2.2 Wu-AGVæ ‡å‡†å·¥åºæ¨¡æ¿

ç³»ç»Ÿå†…ç½®äº†ç¬¦åˆWu-AGVæ ‡å‡†çš„8ç§å·¥åºæ¨¡æ¿ï¼š

#### 2.2.1 åˆ†æ¶²å°ç§»åŠ¨å·¥åº (dispenser_move)
```csharp
var dispenserMoveTemplate = new InstructCombinationVo
{
    CombinationName = "Wu-AGV-dispenser_move",
    BList = new List<InstructUnitVo>
    {
        new InstructUnitVo // 1. æŒ‰ç¼–ç ç»‘å®šåˆ†æ¶²å°è®¾å¤‡
        {
            InstructName = "ç»‘å®šåˆ†æ¶²å°è®¾å¤‡",
            InsType = InstructTypeEnum.binding_by_code,
            OrderNum = 1
        },
        new InstructUnitVo // 2. æ‰§è¡Œç§»åŠ¨åŠ¨ä½œ
        {
            InstructName = "ç§»åŠ¨åˆ°åˆ†æ¶²å°",
            InsType = InstructTypeEnum.move,
            OrderNum = 2,
            ExecuteScriptType = 1, // ä½¿ç”¨åŠ¨æ€è„šæœ¬
            InstructContent = @"
                public string MyMethod(string parm, string persistent, string taskInfo)
                {
                    var taskData = JsonConvert.DeserializeObject<Dictionary<string, object>>(taskInfo);
                    string deviceId = taskData[""mqPickUpCode""].ToString();
                    
                    // è·å–è®¾å¤‡ä½ç½®ä¿¡æ¯
                    var deviceComm = DeviceUtility.GetDevCommByDevCode(deviceId);
                    var position = deviceComm.GetDevicePosition();
                    
                    return JsonConvert.SerializeObject(new { 
                        code = ""1"", 
                        result = $""AGVç§»åŠ¨åˆ°åˆ†æ¶²å°{deviceId}å®Œæˆ"",
                        position = position
                    });
                }"
        }
    }
};
```

#### 2.2.2 åˆ†æä»ªå–æ–™å·¥åº (analyzer_pickup)
```csharp
var analyzerPickupTemplate = new InstructCombinationVo
{
    CombinationName = "Wu-AGV-analyzer_pickup",
    BList = new List<InstructUnitVo>
    {
        new InstructUnitVo // 1. æ™ºèƒ½çŠ¶æ€ç»‘å®šåˆ†æä»ª
        {
            InstructName = "æ™ºèƒ½ç»‘å®šåˆ†æä»ª",
            InsType = InstructTypeEnum.binding_by_status,
            OrderNum = 1,
            ExecuteScriptType = 1,
            InstructContent = @"
                public string MyMethod(string parm, string persistent, string taskInfo)
                {
                    // æ£€æŸ¥åˆ†æä»ªçŠ¶æ€ï¼šå®Œæˆåˆ†æä¸”æœ‰æ ·å“å¾…å–
                    var taskData = JsonConvert.DeserializeObject<Dictionary<string, object>>(taskInfo);
                    string taskSubId = taskData[""taskSubId""].ToString();
                    
                    // ä½¿ç”¨æ™ºèƒ½è®¾å¤‡åˆ†é…åŠ©æ‰‹
                    var device = DeviceAllocationHelper.GetDeviceByTaskTypeAndDevComm(
                        taskSubId, 
                        long.Parse(taskData[""taskId""].ToString()), 
                        ""analyzer_pickup""
                    );
                    
                    if (device != null)
                    {
                        return JsonConvert.SerializeObject(new { 
                            code = ""1"", 
                            result = $""æˆåŠŸç»‘å®šåˆ†æä»ª: {device.DevCode}"" 
                        });
                    }
                    else
                    {
                        return JsonConvert.SerializeObject(new { 
                            code = ""0"", 
                            result = ""æ— å¯ç”¨çš„åˆ†æä»ªè®¾å¤‡"" 
                        });
                    }
                }"
        },
        new InstructUnitVo // 2. çŠ¶æ€æ£€æŸ¥
        {
            InstructName = "æ£€æŸ¥åˆ†æä»ªçŠ¶æ€",
            InsType = InstructTypeEnum.status_get,
            OrderNum = 2,
            CheckFlag = 1,
            CheckScriptType = 1,
            CheckContent = @"
                public string MyMethod(string result, string persistent, string taskInfo)
                {
                    var resultData = JsonConvert.DeserializeObject<Dictionary<string, object>>(result);
                    int status = int.Parse(resultData[""status""].ToString());
                    
                    // çŠ¶æ€ç 3è¡¨ç¤ºåˆ†æå®Œæˆæœ‰æ ·å“å¾…å–
                    if (status == 3)
                    {
                        return JsonConvert.SerializeObject(new { code = 1, result = ""åˆ†æä»ªçŠ¶æ€æ­£å¸¸"" });
                    }
                    else
                    {
                        return JsonConvert.SerializeObject(new { code = 0, result = ""åˆ†æä»ªçŠ¶æ€å¼‚å¸¸"" });
                    }
                }"
        },
        new InstructUnitVo // 3. æ‰§è¡Œå–æ–™åŠ¨ä½œ
        {
            InstructName = "æ‰§è¡Œå–æ–™",
            InsType = InstructTypeEnum.action,
            OrderNum = 3,
            ExecuteScriptType = 1,
            InstructContent = @"
                public string MyMethod(string parm, string persistent, string taskInfo)
                {
                    var taskData = JsonConvert.DeserializeObject<Dictionary<string, object>>(taskInfo);
                    string taskSubId = taskData[""taskSubId""].ToString();
                    
                    // è·å–ç»‘å®šçš„åˆ†æä»ªè®¾å¤‡
                    var analyzerComm = DeviceUtility.GetLockedDevCommByFindType(
                        taskSubId, ""ANALYZER"", FindDevParamType.Find_By_DevCategroyAlias);
                    
                    if (analyzerComm != null)
                    {
                        // æ‰§è¡Œå–æ–™æŒ‡ä»¤
                        var pickupResult = analyzerComm.SendPickupCommand();
                        
                        return JsonConvert.SerializeObject(new { 
                            code = pickupResult.IsSuccess ? ""1"" : ""0"",
                            result = pickupResult.Message
                        });
                    }
                    
                    return JsonConvert.SerializeObject(new { 
                        code = ""0"", 
                        result = ""æœªæ‰¾åˆ°ç»‘å®šçš„åˆ†æä»ªè®¾å¤‡"" 
                    });
                }"
        }
    }
};
```

### 2.3 å·¥åºæ¨¡æ¿ç®¡ç†æœºåˆ¶

```csharp
/// <summary>
/// å·¥åºæ¨¡æ¿ç®¡ç†å™¨
/// </summary>
public class InstructCombinationManager
{
    private static readonly Dictionary<string, InstructCombinationVo> TemplateCache = new();
    
    /// <summary>
    /// æ³¨å†Œå·¥åºæ¨¡æ¿
    /// </summary>
    public static void RegisterTemplate(string templateName, InstructCombinationVo template)
    {
        TemplateCache[templateName] = template;
        LogHelper.WriteSysLog($"å·¥åºæ¨¡æ¿å·²æ³¨å†Œ: {templateName}");
    }
    
    /// <summary>
    /// æ ¹æ®MQTTä»»åŠ¡ç±»å‹è·å–å¯¹åº”å·¥åºæ¨¡æ¿
    /// </summary>
    public static InstructCombinationVo GetTemplateByTaskType(string taskType)
    {
        string templateName = $"Wu-AGV-{taskType}";
        
        if (TemplateCache.TryGetValue(templateName, out var template))
        {
            // æ·±åº¦å…‹éš†æ¨¡æ¿ï¼Œé¿å…ä¿®æ”¹åŸæ¨¡æ¿
            return template.DeepClone();
        }
        
        LogHelper.WriteErrInfo($"æœªæ‰¾åˆ°å·¥åºæ¨¡æ¿: {templateName}");
        return null;
    }
    
    /// <summary>
    /// è·å–æ‰€æœ‰å¯ç”¨å·¥åºæ¨¡æ¿
    /// </summary>
    public static List<string> GetAvailableTemplates()
    {
        return TemplateCache.Keys.ToList();
    }
}
```

---

## 3. ç¡¬ä»¶è®¾å¤‡è°ƒåº¦ç³»ç»Ÿ

### 3.1 è®¾å¤‡è°ƒåº¦æ¶æ„

```
ç¡¬ä»¶è®¾å¤‡è°ƒåº¦æ¶æ„
â”œâ”€â”€ ğŸ¯ DeviceAllocationHelper (è®¾å¤‡åˆ†é…åŠ©æ‰‹)
â”‚   â”œâ”€â”€ æ™ºèƒ½è®¾å¤‡ç»‘å®šç®—æ³•
â”‚   â”œâ”€â”€ è®¾å¤‡çŠ¶æ€æ£€æŸ¥æœºåˆ¶
â”‚   â””â”€â”€ å¤šå€™é€‰è®¾å¤‡ç­–ç•¥
â”‚
â”œâ”€â”€ ğŸ“‹ TaskDeviceConfigService (ä»»åŠ¡è®¾å¤‡é…ç½®æœåŠ¡)
â”‚   â”œâ”€â”€ é»˜è®¤æ¨¡å¼æ˜ å°„
â”‚   â”œâ”€â”€ çµæ´»æ¨¡å¼æ˜ å°„
â”‚   â””â”€â”€ è®¾å¤‡èƒ½åŠ›é…ç½®
â”‚
â””â”€â”€ ğŸ”§ DeviceUtility (è®¾å¤‡å·¥å…·ç±»)
    â”œâ”€â”€ AGVè®¾å¤‡è·å–
    â”œâ”€â”€ æœºå™¨äººè®¾å¤‡è·å–
    â””â”€â”€ é€šç”¨è®¾å¤‡æŸ¥æ‰¾
```

### 3.2 AGVè®¾å¤‡è°ƒåº¦å®ç°

#### 3.2.1 AGVè®¾å¤‡æ™ºèƒ½åˆ†é…

```csharp
/// <summary>
/// æ™ºèƒ½AGVè®¾å¤‡åˆ†é… - æ”¯æŒçŠ¶æ€æ£€æŸ¥å’Œå€™é€‰è®¾å¤‡ç­–ç•¥
/// </summary>
public static DevUnitVo GetDeviceByTaskTypeAndDevComm(string taskSubId, long taskIdValue, 
    string taskTypeCode, bool ignoreAgvStatus = false)
{
    try
    {
        var configService = TaskDeviceConfigService.Instance;
        var config = configService.GetConfig();
        
        List<string> candidateDevices = new List<string>();
        
        if (config.SchedulingMode == "default")
        {
            // é»˜è®¤æ¨¡å¼ï¼šå›ºå®šè®¾å¤‡åˆ†é…
            string deviceCode = config.DefaultModeMapping.GetValueOrDefault(taskTypeCode);
            if (!string.IsNullOrEmpty(deviceCode))
            {
                candidateDevices.Add(deviceCode);
            }
        }
        else
        {
            // çµæ´»æ¨¡å¼ï¼šå¤šå€™é€‰è®¾å¤‡
            var deviceList = config.FlexibleModeMapping.GetValueOrDefault(taskTypeCode);
            if (deviceList != null && deviceList.Count > 0)
            {
                candidateDevices.AddRange(deviceList);
            }
        }

        // éå†å€™é€‰è®¾å¤‡ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„
        foreach (string deviceCode in candidateDevices)
        {
            var device = TryAllocateDevice(taskSubId, taskIdValue, deviceCode, ignoreAgvStatus);
            if (device != null)
            {
                LogHelper.WriteSysLog($"æˆåŠŸåˆ†é…è®¾å¤‡: {deviceCode} ç»™ä»»åŠ¡: {taskSubId}");
                return device;
            }
        }
        
        return null;
    }
    catch (Exception ex)
    {
        LogHelper.WriteErrInfo($"è®¾å¤‡åˆ†é…å¤±è´¥: {ex.Message}");
        return null;
    }
}

/// <summary>
/// å°è¯•åˆ†é…ç‰¹å®šè®¾å¤‡
/// </summary>
private static DevUnitVo TryAllocateDevice(string taskSubId, long taskIdValue, 
    string deviceCode, bool ignoreAgvStatus)
{
    var deviceManager = CcdqFactory.GetMainController().DevManager;
    var device = deviceManager.GetDevUnitVoByDevCode(deviceCode);
    
    if (device == null) return null;
    
    // AGVè®¾å¤‡ç‰¹æ®Šå¤„ç† - çŠ¶æ€æ£€æŸ¥
    if (device.DevMode?.DevCategory?.DevAlias == "AGV" && !ignoreAgvStatus)
    {
        if (!CheckAgvStatus(device))
        {
            LogHelper.WriteSysLog($"AGVè®¾å¤‡ {deviceCode} çŠ¶æ€æ£€æŸ¥å¤±è´¥");
            return null;
        }
    }
    
    // å°è¯•é”å®šè®¾å¤‡
    bool lockSuccess = deviceManager.LockDevice(device.Id, taskSubId, taskIdValue);
    
    if (lockSuccess)
    {
        return device;
    }
    
    return null;
}
```

#### 3.2.2 AGVçŠ¶æ€æ£€æŸ¥æœºåˆ¶

```csharp
/// <summary>
/// AGVçŠ¶æ€æ£€æŸ¥ - æ”¯æŒè„šæœ¬åŒ–çŠ¶æ€éªŒè¯
/// </summary>
private static bool CheckAgvStatus(DevUnitVo device)
{
    try
    {
        // 1. å°è¯•è¯»å–è‡ªå®šä¹‰çŠ¶æ€æ£€æŸ¥è„šæœ¬
        string scriptPath = Path.Combine(CcdqSystemConst.PATH, 
            "pnCfg", "scripts", "seerAgvStatusScript.cs");
        
        if (File.Exists(scriptPath))
        {
            string scriptContent = File.ReadAllText(scriptPath);
            var result = ExecuteStatusCheckScript(device, scriptContent);
            return result == "1"; // è„šæœ¬è¿”å›"1"è¡¨ç¤ºçŠ¶æ€æ­£å¸¸
        }
        
        // 2. ä½¿ç”¨å†…ç½®çŠ¶æ€æ£€æŸ¥é€»è¾‘
        return CheckDefaultAgvStatus(device);
    }
    catch (Exception ex)
    {
        LogHelper.WriteErrInfo($"AGVçŠ¶æ€æ£€æŸ¥å¼‚å¸¸: {ex.Message}");
        return false;
    }
}

/// <summary>
/// æ‰§è¡ŒçŠ¶æ€æ£€æŸ¥è„šæœ¬
/// </summary>
private static string ExecuteStatusCheckScript(DevUnitVo device, string scriptContent)
{
    var deviceComm = CcdqFactory.GetMainController().DevManager.GetDevCommByDevId(device.Id);
    if (deviceComm == null) return "0";
    
    // æ„å»ºè„šæœ¬æ‰§è¡Œå‚æ•°
    var taskInfo = JsonConvert.SerializeObject(new
    {
        deviceId = device.Id,
        deviceCode = device.DevCode,
        deviceType = device.DevMode?.DevCategory?.DevAlias
    });
    
    // æ‰§è¡Œè„šæœ¬
    var scriptResult = ScriptExecuteTools.ScriptCompile(
        "", "", scriptContent, taskInfo, device.Id, 0);
    
    if (scriptResult.Code == 1)
    {
        var resultData = JsonConvert.DeserializeObject<Dictionary<string, object>>(scriptResult.Result);
        return resultData.GetValueOrDefault("result", "0").ToString();
    }
    
    return "0";
}
```

### 3.3 æœºå™¨äººè®¾å¤‡è°ƒåº¦

```csharp
/// <summary>
/// æœºå™¨äººè®¾å¤‡è·å–å·¥å…·
/// </summary>
public static class RobotDeviceUtility
{
    /// <summary>
    /// è·å–ä»»åŠ¡é”å®šçš„æœºå™¨äººè®¾å¤‡
    /// </summary>
    public static DevUnitVo GetLockedRobotByLockId(string lockId)
    {
        try
        {
            var deviceManager = CcdqFactory.GetMainController().DevManager;
            var lockedDevices = deviceManager.GetLockedDevicesByLockId(lockId);
            
            return lockedDevices?.FirstOrDefault(d => 
                d.DevMode?.DevCategory?.DevAlias == "ROBOT");
        }
        catch (Exception ex)
        {
            LogHelper.WriteErrInfo($"è·å–æœºå™¨äººè®¾å¤‡å¤±è´¥: {ex.Message}");
            return null;
        }
    }
    
    /// <summary>
    /// è·å–æœºå™¨äººè®¾å¤‡é€šä¿¡å¯¹è±¡
    /// </summary>
    public static DevComm GetRobotDevComm(string lockId)
    {
        var robotDevice = GetLockedRobotByLockId(lockId);
        if (robotDevice != null)
        {
            var deviceManager = CcdqFactory.GetMainController().DevManager;
            return deviceManager.GetDevCommByDevId(robotDevice.Id);
        }
        return null;
    }
}
```

---

## 4. å¤šåè®®é€šä¿¡æ”¯æŒæ¶æ„

### 4.1 é€šä¿¡åè®®æ˜ å°„é…ç½®

```json
// Cfg/commdef.cfg - é€šä¿¡åè®®é»˜è®¤å®ç°æ˜ å°„
{
    "TCP": "CcdqCommLib.CcdqCommTcp",
    "HTTP": "CcdqCommLib.CcdqCommHttp", 
    "MODBUS_TCP": "CcdqCommLib.CcdqCommModbusTcp",
    "MODBUS_RTU": "CcdqCommLib.CcdqCommModbusRtu"
}
```

### 4.2 ModbusTCPåè®®å®ç°

#### 4.2.1 ModbusTCPé€šä¿¡ç±»

```csharp
/// <summary>
/// ModbusTCPé€šä¿¡å®ç°ç±»
/// æ”¯æŒæ ‡å‡†ModbusåŠŸèƒ½ç å’Œæ•°æ®ç±»å‹
/// </summary>
public class CcdqCommModbusTcp : AbstractComm
{
    private ModbusTcpNet modbusTcpNet;
    private byte station;

    public override bool Connect()
    {
        try
        {
            station = Convert.ToByte(Dev.Station);
            
            if (modbusTcpNet == null)
            {
                modbusTcpNet = new ModbusTcpNet(this.IPAddress, this.Port, station);
                modbusTcpNet.AddressStartWithZero = Dev.StartZero == 1;
                modbusTcpNet.IsCheckMessageId = true;
                
                if (Dev.DataFormat >= 0)
                {
                    modbusTcpNet.DataFormat = (DataFormat)Dev.DataFormat;
                }

                OperateResult opr = modbusTcpNet.ConnectServer();
                if (opr.IsSuccess)
                {
                    IsConnected = true;
                    Dev.SetReady();
                    FireStatusAction(this.Dev, null);
                    return true;
                }
            }
        }
        catch (Exception ex)
        {
            LogHelper.WriteErrInfo($"ModbusTCPè¿æ¥å¤±è´¥: {ex.Message}");
        }
        return false;
    }

    public override CommResult SendInfo(CommSendInfo sendInfo)
    {
        // è§£æModbuså‚æ•°
        var modbusParams = ParseModbusParameters(sendInfo);
        
        CommResult commResult = new CommResult() { ResultFlag = CommResultFlag.Fail };
        
        try
        {
            if (modbusParams.IsWrite)
            {
                commResult = ModbusTools.WriteValue(
                    modbusParams.Content, 
                    modbusParams.Address, 
                    modbusParams.Length,
                    modbusParams.FunctionCode, 
                    modbusParams.DataType, 
                    modbusTcpNet
                );
            }
            else if (modbusParams.IsRead)
            {
                commResult = ModbusTools.ReadValue(
                    modbusParams.Content,
                    modbusParams.Address,
                    modbusParams.Length,
                    modbusParams.FunctionCode,
                    modbusParams.DataType,
                    modbusTcpNet,
                    commResult
                );
            }
        }
        catch (Exception ex)
        {
            commResult.Msg = $"ModbusTCPé€šä¿¡å¼‚å¸¸: {ex.Message}";
            LogHelper.WriteErrInfo(commResult.Msg);
        }
        
        return commResult;
    }
}
```

#### 4.2.2 Modbuså·¥å…·ç±»

```csharp
/// <summary>
/// Modbusé€šä¿¡å·¥å…·ç±»
/// ç»Ÿä¸€å¤„ç†å„ç§Modbusæ•°æ®ç±»å‹å’ŒåŠŸèƒ½ç 
/// </summary>
public static class ModbusTools
{
    /// <summary>
    /// å†™å…¥Modbusæ•°æ®
    /// </summary>
    public static CommResult WriteValue(string content, string address, int length,
        ModbusFuncCode funcCode, ModbusDataType dataType, ModbusTcpNet modbusTcp)
    {
        CommResult result = new CommResult();
        
        try
        {
            switch (funcCode)
            {
                case ModbusFuncCode.Write_Single_Coil:
                    var boolResult = modbusTcp.WriteBool(address, bool.Parse(content));
                    result.ResultFlag = boolResult.IsSuccess ? CommResultFlag.Ok : CommResultFlag.Fail;
                    result.Msg = boolResult.Message;
                    break;
                    
                case ModbusFuncCode.Write_Single_Register:
                    switch (dataType)
                    {
                        case ModbusDataType.Short:
                            var shortResult = modbusTcp.WriteInt16(address, short.Parse(content));
                            result.ResultFlag = shortResult.IsSuccess ? CommResultFlag.Ok : CommResultFlag.Fail;
                            break;
                        case ModbusDataType.Int:
                            var intResult = modbusTcp.WriteInt32(address, int.Parse(content));
                            result.ResultFlag = intResult.IsSuccess ? CommResultFlag.Ok : CommResultFlag.Fail;
                            break;
                        case ModbusDataType.Float:
                            var floatResult = modbusTcp.WriteFloat(address, float.Parse(content));
                            result.ResultFlag = floatResult.IsSuccess ? CommResultFlag.Ok : CommResultFlag.Fail;
                            break;
                    }
                    break;
            }
        }
        catch (Exception ex)
        {
            result.ResultFlag = CommResultFlag.Fail;
            result.Msg = $"Modbuså†™å…¥å¼‚å¸¸: {ex.Message}";
        }
        
        return result;
    }
    
    /// <summary>
    /// è¯»å–Modbusæ•°æ®
    /// </summary>
    public static CommResult ReadValue(string content, string address, int length,
        ModbusFuncCode funcCode, ModbusDataType dataType, ModbusTcpNet modbusTcp, CommResult commResult)
    {
        try
        {
            switch (funcCode)
            {
                case ModbusFuncCode.Read_Coils:
                    var boolArrayResult = modbusTcp.ReadBool(address, (ushort)length);
                    if (boolArrayResult.IsSuccess)
                    {
                        commResult.ResultValue = boolArrayResult.Content;
                        commResult.ResultFlag = CommResultFlag.Ok;
                    }
                    break;
                    
                case ModbusFuncCode.Read_Holding_Inputs:
                    switch (dataType)
                    {
                        case ModbusDataType.Short:
                            var shortArrayResult = modbusTcp.ReadInt16(address, (ushort)length);
                            if (shortArrayResult.IsSuccess)
                            {
                                commResult.ResultValue = shortArrayResult.Content;
                                commResult.ResultFlag = CommResultFlag.Ok;
                            }
                            break;
                        case ModbusDataType.Int:
                            var intArrayResult = modbusTcp.ReadInt32(address, (ushort)length);
                            if (intArrayResult.IsSuccess)
                            {
                                commResult.ResultValue = intArrayResult.Content;
                                commResult.ResultFlag = CommResultFlag.Ok;
                            }
                            break;
                        case ModbusDataType.Float:
                            var floatArrayResult = modbusTcp.ReadFloat(address, (ushort)length);
                            if (floatArrayResult.IsSuccess)
                            {
                                commResult.ResultValue = floatArrayResult.Content;
                                commResult.ResultFlag = CommResultFlag.Ok;
                            }
                            break;
                    }
                    break;
            }
        }
        catch (Exception ex)
        {
            commResult.ResultFlag = CommResultFlag.Fail;
            commResult.Msg = $"Modbusè¯»å–å¼‚å¸¸: {ex.Message}";
        }
        
        return commResult;
    }
}
```

### 4.3 HTTPåè®®æ”¯æŒ

```csharp
/// <summary>
/// HTTPé€šä¿¡å®ç°ç±»
/// æ”¯æŒRESTful APIè°ƒç”¨å’ŒWebæœåŠ¡é›†æˆ
/// </summary>
public class CcdqCommHttp : AbstractComm
{
    private HttpClient httpClient;
    
    public override bool Connect()
    {
        try
        {
            httpClient = new HttpClient();
            httpClient.BaseAddress = new Uri($"http://{IPAddress}:{Port}");
            httpClient.Timeout = TimeSpan.FromSeconds(30);
            
            // è®¾ç½®é»˜è®¤è¯·æ±‚å¤´
            httpClient.DefaultRequestHeaders.Add("User-Agent", "SchedAppCore/1.0");
            
            IsConnected = true;
            Dev.SetReady();
            return true;
        }
        catch (Exception ex)
        {
            LogHelper.WriteErrInfo($"HTTPè¿æ¥åˆå§‹åŒ–å¤±è´¥: {ex.Message}");
            return false;
        }
    }
    
    public override CommResult SendInfo(CommSendInfo sendInfo)
    {
        CommResult result = new CommResult();
        
        try
        {
            var httpParams = ParseHttpParameters(sendInfo.InstructUnit.InstructContent);
            
            HttpResponseMessage response;
            
            switch (httpParams.Method.ToUpper())
            {
                case "GET":
                    response = httpClient.GetAsync(httpParams.Url).Result;
                    break;
                case "POST":
                    var content = new StringContent(httpParams.Body, Encoding.UTF8, "application/json");
                    response = httpClient.PostAsync(httpParams.Url, content).Result;
                    break;
                case "PUT":
                    var putContent = new StringContent(httpParams.Body, Encoding.UTF8, "application/json");
                    response = httpClient.PutAsync(httpParams.Url, putContent).Result;
                    break;
                default:
                    throw new NotSupportedException($"ä¸æ”¯æŒçš„HTTPæ–¹æ³•: {httpParams.Method}");
            }
            
            if (response.IsSuccessStatusCode)
            {
                result.ResultValue = response.Content.ReadAsStringAsync().Result;
                result.ResultFlag = CommResultFlag.Ok;
                result.Msg = "HTTPè¯·æ±‚æˆåŠŸ";
            }
            else
            {
                result.ResultFlag = CommResultFlag.Fail;
                result.Msg = $"HTTPè¯·æ±‚å¤±è´¥: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            result.ResultFlag = CommResultFlag.Fail;
            result.Msg = $"HTTPé€šä¿¡å¼‚å¸¸: {ex.Message}";
        }
        
        return result;
    }
}
```

---

## 5. è„šæœ¬åŒ–è®¾å¤‡è°ƒåº¦ç¤ºä¾‹

### 5.1 AGVè¿è¾“ä»»åŠ¡è„šæœ¬

```csharp
/// <summary>
/// AGVæ ·å“è¿è¾“ä»»åŠ¡è„šæœ¬
/// å±•ç¤ºäº†å®Œæ•´çš„AGVè°ƒåº¦æµç¨‹
/// </summary>
public string MyMethod(string parm, string persistent, string taskInfo)
{
    Dictionary<string, string> dict = new Dictionary<string, string>();
    
    try
    {
        var taskData = JsonConvert.DeserializeObject<Dictionary<string, string>>(taskInfo);
        string taskSubId = taskData["taskSubId"];
        string externalTaskId = taskData["externalTaskId"];
        
        var mqttController = CcdqFactory.GetMainController().MqttController;
        
        // æ­¥éª¤1ï¼šè·å–AGVè®¾å¤‡
        mqttController.PublishStepStatus(externalTaskId, "è·å–AGVè®¾å¤‡", StepStatus.InProgress);
        
        var agvDevice = DeviceUtility.GetLockedAgvByLockId(taskSubId);
        if (agvDevice == null)
        {
            dict.Add("code", "0");
            dict.Add("result", "å½“å‰ä»»åŠ¡æœªç»‘å®šAGVè®¾å¤‡");
            return FileIOTools.SerializeObject(dict);
        }
        
        // æ­¥éª¤2ï¼šæŠ¢å AGVæ§åˆ¶æƒ
        mqttController.PublishStepStatus(externalTaskId, "æŠ¢å AGVæ§åˆ¶æƒ", StepStatus.InProgress);
        
        var lockResult = SeerTcpInterfaceHelper.SendMsgLockReq(agvDevice);
        if (!lockResult.Success)
        {
            mqttController.PublishStandardError(StandardErrorCode.E2000_CommunicationLoss, 
                $"æŠ¢å æ§åˆ¶æƒå¤±è´¥: {lockResult.Message}", externalTaskId);
            dict.Add("code", "0");
            dict.Add("result", $"æŠ¢å æ§åˆ¶æƒå¤±è´¥: {lockResult.Message}");
            return FileIOTools.SerializeObject(dict);
        }
        
        mqttController.PublishStepStatus(externalTaskId, "æŠ¢å AGVæ§åˆ¶æƒ", StepStatus.Completed);
        
        dict.Add("code", "1");
        dict.Add("result", "AGVè¿è¾“ä»»åŠ¡å®Œæˆ");
    }
    catch (Exception ex)
    {
        dict.Add("code", "0");
        dict.Add("result", $"è„šæœ¬æ‰§è¡Œå¼‚å¸¸: {ex.Message}");
    }
    
    return FileIOTools.SerializeObject(dict);
}
```

### 5.2 æœºå™¨äººæ“ä½œè„šæœ¬

```csharp
/// <summary>
/// æœºå™¨äººæ ·å“å¤„ç†è„šæœ¬
/// å±•ç¤ºäº†æœºå™¨äººçš„ç²¾ç¡®æ“ä½œæ§åˆ¶
/// </summary>
public string MyMethod(string parm, string persistent, string taskInfo)
{
    Dictionary<string, string> dict = new Dictionary<string, string>();
    
    try
    {
        var taskData = JsonConvert.DeserializeObject<Dictionary<string, string>>(taskInfo);
        string taskSubId = taskData["taskSubId"];
        
        // è·å–æœºå™¨äººè®¾å¤‡é€šä¿¡å¯¹è±¡
        var robotComm = DeviceUtility.GetRobotDevComm(taskSubId);
        if (robotComm == null)
        {
            dict.Add("code", "0");
            dict.Add("result", "æœªæ‰¾åˆ°æœºå™¨äººè®¾å¤‡");
            return FileIOTools.SerializeObject(dict);
        }
        
        // æ­¥éª¤1ï¼šæœºå™¨äººåˆå§‹åŒ–
        var initResult = ModbusUtility.WriteModbus(robotComm, "40001", 1, ModbusFuncCode.Write_Single_Register);
        if (!initResult.IsSuccess)
        {
            dict.Add("code", "0");
            dict.Add("result", "æœºå™¨äººåˆå§‹åŒ–å¤±è´¥");
            return FileIOTools.SerializeObject(dict);
        }
        
        // æ­¥éª¤2ï¼šç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
        string targetX = taskData.GetValueOrDefault("targetX", "0");
        string targetY = taskData.GetValueOrDefault("targetY", "0");
        string targetZ = taskData.GetValueOrDefault("targetZ", "0");
        
        var moveXResult = ModbusUtility.WriteModbus(robotComm, "40010", float.Parse(targetX), ModbusFuncCode.Write_Single_Register);
        var moveYResult = ModbusUtility.WriteModbus(robotComm, "40011", float.Parse(targetY), ModbusFuncCode.Write_Single_Register);
        var moveZResult = ModbusUtility.WriteModbus(robotComm, "40012", float.Parse(targetZ), ModbusFuncCode.Write_Single_Register);
        
        if (moveXResult.IsSuccess && moveYResult.IsSuccess && moveZResult.IsSuccess)
        {
            // æ­¥éª¤3ï¼šæ‰§è¡ŒæŠ“å–åŠ¨ä½œ
            var gripResult = ModbusUtility.WriteModbus(robotComm, "40020", 1, ModbusFuncCode.Write_Single_Register);
            
            if (gripResult.IsSuccess)
            {
                // æ­¥éª¤4ï¼šæ£€æŸ¥æŠ“å–çŠ¶æ€
                Thread.Sleep(2000); // ç­‰å¾…åŠ¨ä½œå®Œæˆ
                var statusResult = ModbusUtility.ReadModbus<short>(robotComm, "40021", ModbusFuncCode.Read_Holding_Inputs);
                
                if (statusResult.IsSuccess && statusResult.Value == 1)
                {
                    dict.Add("code", "1");
                    dict.Add("result", "æœºå™¨äººæ“ä½œå®Œæˆ");
                }
                else
                {
                    dict.Add("code", "0");
                    dict.Add("result", "æŠ“å–éªŒè¯å¤±è´¥");
                }
            }
            else
            {
                dict.Add("code", "0");
                dict.Add("result", "æ‰§è¡ŒæŠ“å–å¤±è´¥");
            }
        }
        else
        {
            dict.Add("code", "0");
            dict.Add("result", "æœºå™¨äººç§»åŠ¨å¤±è´¥");
        }
    }
    catch (Exception ex)
    {
        dict.Add("code", "0");
        dict.Add("result", $"æœºå™¨äººæ“ä½œå¼‚å¸¸: {ex.Message}");
    }
    
    return FileIOTools.SerializeObject(dict);
}
```

---

## 6. äº§å“åŒ–ä»·å€¼æ€»ç»“

### 6.1 æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

```
SchedAppCoreè°ƒåº¦å¹³å°æ ¸å¿ƒä¼˜åŠ¿
â”œâ”€â”€ ğŸ¯ è„šæœ¬åŒ–å·¥åºç®¡ç†
â”‚   â”œâ”€â”€ C#/PythonåŒè¯­è¨€æ”¯æŒ
â”‚   â”œâ”€â”€ åŠ¨æ€ç¼–è¯‘æ‰§è¡Œå¼•æ“  
â”‚   â”œâ”€â”€ ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¼ é€’
â”‚   â””â”€â”€ æ¨¡æ¿åŒ–å·¥åºè®¾è®¡
â”‚
â”œâ”€â”€ ğŸ¤– æ™ºèƒ½è®¾å¤‡è°ƒåº¦
â”‚   â”œâ”€â”€ å¤šåè®®ç»Ÿä¸€æ¥å£
â”‚   â”œâ”€â”€ æ™ºèƒ½è®¾å¤‡åˆ†é…ç®—æ³•
â”‚   â”œâ”€â”€ çŠ¶æ€æ£€æŸ¥ä¸æ•…éšœå¤„ç†
â”‚   â””â”€â”€ AGV/æœºå™¨äººä¸“ä¸šåŒ–æ”¯æŒ
â”‚
â”œâ”€â”€ ğŸ”Œ å…¨åè®®é€šä¿¡æ”¯æŒ
â”‚   â”œâ”€â”€ ModbusTCP/RTUåè®®
â”‚   â”œâ”€â”€ HTTP RESTful API
â”‚   â”œâ”€â”€ TCP Socketé€šä¿¡
â”‚   â””â”€â”€ æ’ä»¶åŒ–åè®®æ‰©å±•
â”‚
â””â”€â”€ ğŸ“Š äº§å“åŒ–ç®¡ç†åŠŸèƒ½
    â”œâ”€â”€ å·¥åºæ¨¡æ¿åº“ç®¡ç†
    â”œâ”€â”€ è®¾å¤‡é…ç½®ä¸­å¿ƒ
    â”œâ”€â”€ ä»»åŠ¡è°ƒåº¦å¼•æ“
    â””â”€â”€ å®æ—¶ç›‘æ§ä½“ç³»
```

### 6.2 åº”ç”¨åœºæ™¯é€‚é…

**æ™ºèƒ½åˆ¶é€ åœºæ™¯**ï¼š
- æ”¯æŒå¤šç§å·¥ä¸šæœºå™¨äººå“ç‰Œ
- å…¼å®¹ä¸»æµPLCå’Œæ§åˆ¶å™¨
- çµæ´»çš„å·¥è‰ºæµç¨‹å®šåˆ¶

**å®éªŒå®¤è‡ªåŠ¨åŒ–**ï¼š
- Wu-AGVæ ‡å‡†å®Œå…¨å…¼å®¹
- æ ·å“è·Ÿè¸ªå…¨æµç¨‹ç®¡ç†
- å¤šè®¾å¤‡ååŒä½œä¸š

**ç‰©æµä»“å‚¨**ï¼š
- AGVè°ƒåº¦ç®—æ³•ä¼˜åŒ–
- è·¯å¾„è§„åˆ’é›†æˆ
- åº“å­˜ç®¡ç†è”åŠ¨

### 6.3 æ ¸å¿ƒç«äº‰åŠ›

1. **æŠ€æœ¯æ·±åº¦**ï¼šåŠ¨æ€è„šæœ¬å¼•æ“å®ç°äº†å‰æ‰€æœªæœ‰çš„çµæ´»æ€§
2. **åè®®å¹¿åº¦**ï¼šå¤šåè®®æ”¯æŒè¦†ç›–90%ä»¥ä¸Šå·¥ä¸šè®¾å¤‡
3. **å¹³å°åŒ–**ï¼šæ¨¡å—åŒ–è®¾è®¡æ”¯æŒå¿«é€ŸäºŒæ¬¡å¼€å‘
4. **æ ‡å‡†åŒ–**ï¼šWu-AGVç­‰è¡Œä¸šæ ‡å‡†æ·±åº¦é›†æˆ
5. **æ™ºèƒ½åŒ–**ï¼šAIç®—æ³•ä¼˜åŒ–çš„è®¾å¤‡è°ƒåº¦ç­–ç•¥

**SchedAppCoreä¸ä»…æ˜¯ä¸€ä¸ªè°ƒåº¦å¹³å°ï¼Œæ›´æ˜¯å·¥ä¸š4.0æ—¶ä»£çš„æ™ºèƒ½åˆ¶é€ å¤§è„‘ï¼**

---

**æ–‡æ¡£å®Œæˆæ—¶é—´ï¼š** 2025-06-18 23:46:48 