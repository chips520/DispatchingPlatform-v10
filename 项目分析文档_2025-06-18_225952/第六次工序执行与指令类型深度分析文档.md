# SchedAppCore é¡¹ç›®ç¬¬å…­æ¬¡åˆ†ææ–‡æ¡£ï¼šå·¥åºæ‰§è¡Œä¸æŒ‡ä»¤ç±»å‹æ·±åº¦è§£æ

**åˆ†ææ—¶é—´ï¼š** 2025-06-18 23:50:00  
**åˆ†æèŒƒå›´ï¼š** è°ƒåº¦å·¥åºæ‰§è¡Œæœºåˆ¶ã€æŒ‡ä»¤ç±»å‹ä½“ç³»ã€å„ç§æŒ‡ä»¤æ‰§è¡ŒåŠŸèƒ½æ·±åº¦ç†è§£  
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** ç¬¬å…­æ¬¡åˆ†æ - å·¥åºæ‰§è¡Œä¸æŒ‡ä»¤ä½“ç³»å‰–æ  
**é‡ç‚¹å†…å®¹ï¼š** æŒ‡ä»¤ç±»å‹æšä¸¾ã€å·¥åºæ‰§è¡Œç®—æ³•ã€ä¸šåŠ¡æŒ‡ä»¤åŠŸèƒ½åˆ†æ

---

## 1. æŒ‡ä»¤ç±»å‹ä½“ç³»å®Œæ•´æ¶æ„

### 1.1 InstructTypeEnum æŒ‡ä»¤ç±»å‹æšä¸¾å®Œæ•´å®šä¹‰

```csharp
public enum InstructTypeEnum
{
    cnc_write = 0,          // CNCè®¾å¤‡å†™å…¥æŒ‡ä»¤
    status_get = 1,         // çŠ¶æ€è·å–æŒ‡ä»¤
    condition_if = 2,       // æ¡ä»¶åˆ¤æ–­æŒ‡ä»¤
    status_get_free = 3,    // è·å–ç©ºé—²çŠ¶æ€æŒ‡ä»¤
    action = 4,             // åŠ¨ä½œæ‰§è¡ŒæŒ‡ä»¤
    move = 5,               // ç§»åŠ¨æŒ‡ä»¤
    binding = 7,            // è®¾å¤‡ç»‘å®šæŒ‡ä»¤
    unbinding = 8,          // è®¾å¤‡è§£ç»‘æŒ‡ä»¤
    normal = 10,            // æ™®é€šé€šä¿¡æŒ‡ä»¤
    binding_by_status = 11, // æŒ‰çŠ¶æ€ç»‘å®šè®¾å¤‡æŒ‡ä»¤
    dev_pos = 12,           // è®¾å¤‡ä½ç½®è·å–æŒ‡ä»¤
    http_req = 13,          // HTTPè¯·æ±‚æŒ‡ä»¤
    dev_coords = 14,        // è®¾å¤‡åæ ‡è·å–æŒ‡ä»¤
    binding_by_code = 15,   // æŒ‰ç¼–ç ç»‘å®šè®¾å¤‡æŒ‡ä»¤
    finished = 16,          // ä»»åŠ¡å®ŒæˆæŒ‡ä»¤
    skip_loop = 17,         // è·³è¿‡å¾ªç¯æŒ‡ä»¤
    continue_same_level = 18, // åŒçº§ç»§ç»­æŒ‡ä»¤
    finished_real = 19,     // çœŸå®å®ŒæˆæŒ‡ä»¤
    none = 100,             // æ— æ•ˆæŒ‡ä»¤ç±»å‹
}
```

### 1.2 æŒ‡ä»¤åˆ†ç±»çŸ©é˜µ

```
æŒ‡ä»¤åŠŸèƒ½åˆ†ç±»ä½“ç³»
â”œâ”€â”€ ğŸ“¡ é€šä¿¡æ§åˆ¶ç±»æŒ‡ä»¤
â”‚   â”œâ”€â”€ normal(10) - æ™®é€šè®¾å¤‡é€šä¿¡
â”‚   â”œâ”€â”€ http_req(13) - HTTPæ¥å£è°ƒç”¨
â”‚   â”œâ”€â”€ cnc_write(0) - CNCè®¾å¤‡ä¸“ç”¨å†™å…¥
â”‚   â””â”€â”€ action(4) - åŠ¨ä½œæ‰§è¡Œç±»æŒ‡ä»¤
â”‚
â”œâ”€â”€ ğŸ“Š çŠ¶æ€æŸ¥è¯¢ç±»æŒ‡ä»¤
â”‚   â”œâ”€â”€ status_get(1) - è·å–è®¾å¤‡çŠ¶æ€
â”‚   â”œâ”€â”€ status_get_free(3) - è·å–ç©ºé—²çŠ¶æ€
â”‚   â”œâ”€â”€ dev_pos(12) - è·å–è®¾å¤‡ä½ç½®
â”‚   â””â”€â”€ dev_coords(14) - è·å–è®¾å¤‡åæ ‡
â”‚
â”œâ”€â”€ ğŸ”— è®¾å¤‡ç®¡ç†ç±»æŒ‡ä»¤
â”‚   â”œâ”€â”€ binding(7) - æ ‡å‡†è®¾å¤‡ç»‘å®š
â”‚   â”œâ”€â”€ unbinding(8) - è®¾å¤‡è§£ç»‘é‡Šæ”¾
â”‚   â”œâ”€â”€ binding_by_status(11) - æŒ‰çŠ¶æ€æ™ºèƒ½ç»‘å®š
â”‚   â””â”€â”€ binding_by_code(15) - æŒ‰ç¼–ç ç²¾ç¡®ç»‘å®š
â”‚
â”œâ”€â”€ ğŸ”„ æµç¨‹æ§åˆ¶ç±»æŒ‡ä»¤
â”‚   â”œâ”€â”€ condition_if(2) - æ¡ä»¶åˆ†æ”¯æ§åˆ¶
â”‚   â”œâ”€â”€ move(5) - AGVç§»åŠ¨æ§åˆ¶
â”‚   â”œâ”€â”€ skip_loop(17) - å¾ªç¯è·³å‡ºæ§åˆ¶
â”‚   â””â”€â”€ continue_same_level(18) - åŒçº§ç»§ç»­æ§åˆ¶
â”‚
â””â”€â”€ ğŸ ä»»åŠ¡ç»“æŸç±»æŒ‡ä»¤
    â”œâ”€â”€ finished(16) - æ ‡å‡†ä»»åŠ¡å®Œæˆ
    â”œâ”€â”€ finished_real(19) - å¼ºåˆ¶çœŸå®å®Œæˆ
    â””â”€â”€ none(100) - æ— æ•ˆæŒ‡ä»¤æ ‡è¯†
```

---

## 2. æ ¸å¿ƒå·¥åºæ‰§è¡Œå¼•æ“æ·±åº¦åˆ†æ

### 2.1 InsUnitCommunication - æŒ‡ä»¤é€šä¿¡å¼•æ“æ¶æ„

```csharp
// æŒ‡ä»¤æ‰§è¡Œæ ¸å¿ƒæµç¨‹
private CommResult InsUnitCommunication(InstructUnitVo unit, CommResult lastResult, 
    CommResult lastPersistent, int curIdx, bool loopCtr = true, bool isStepMode = false)
{
    // 1. è¶…æ—¶æ§åˆ¶æœºåˆ¶
    int timeOut = unit.TimeOut;
    DateTime lastDt = DateTime.Now;
    long lastTicks = lastDt.Ticks;
    
    // 2. å¾ªç¯æ‰§è¡Œæ§åˆ¶
    bool isLoop = true;
    while (isLoop)
    {
        // 3. è¿è¡ŒçŠ¶æ€æ£€æŸ¥
        if (!isStepMode && (!IsRunningEnable() || MainTools.IsTaskStateFlag(this.StateFlag, TaskStatusFlag.Pause)))
        {
            isLoop = false;
            break;
        }
        
        // 4. æ¶ˆæ¯IDç”Ÿæˆ
        string msgId = $"{UtilityTools.GetRandomCode("IU")}";
        
        // 5. æŒ‡ä»¤ç±»å‹è§£æ
        InstructTypeEnum insTypeEnum = unit.InsType;
        
        // 6. æŒ‰æŒ‡ä»¤ç±»å‹åˆ†å‘æ‰§è¡Œ
        CommResult unitResult = ExecuteByInstructType(insTypeEnum, unit, lastResult, 
            lastPersistent, msgId, curIdx, lastTicks);
        
        // 7. æ‰§è¡Œç»“æœåˆ¤æ–­ä¸å¾ªç¯æ§åˆ¶
        if (unitResult.ResultFlag == CommResultFlag.Ok || unitResult.ResultFlag == CommResultFlag.If_Ok)
        {
            isLoop = false; // æˆåŠŸæ‰§è¡Œï¼Œé€€å‡ºå¾ªç¯
        }
        else
        {
            // 8. å¤±è´¥é‡è¯•æœºåˆ¶
            bool isLoopFlag = unit.LoopFlag == 1;
            if (isLoopFlag && loopCtr && (unitResult.ResultFlag != CommResultFlag.Alarm 
                && unitResult.ResultFlag != CommResultFlag.If_Fail))
            {
                int t = unit.IntervalTimes < 100 ? 100 : unit.IntervalTimes;
                Thread.Sleep(t); // ç­‰å¾…é‡è¯•é—´éš”
                continue; // ç»§ç»­å¾ªç¯é‡è¯•
            }
            else
            {
                isLoop = false; // ä¸æ»¡è¶³é‡è¯•æ¡ä»¶ï¼Œé€€å‡ºå¾ªç¯
            }
        }
    }
    
    return unitResult;
}
```

### 2.2 æŒ‡ä»¤æ‰§è¡Œæµç¨‹çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> æŒ‡ä»¤è§£æ
    æŒ‡ä»¤è§£æ --> è®¾å¤‡ç»‘å®šç±»
    æŒ‡ä»¤è§£æ --> çŠ¶æ€æŸ¥è¯¢ç±»
    æŒ‡ä»¤è§£æ --> é€šä¿¡æ§åˆ¶ç±»
    æŒ‡ä»¤è§£æ --> æµç¨‹æ§åˆ¶ç±»
    æŒ‡ä»¤è§£æ --> ä»»åŠ¡ç»“æŸç±»
    
    è®¾å¤‡ç»‘å®šç±» --> è®¾å¤‡é”å®šæ£€æŸ¥
    è®¾å¤‡é”å®šæ£€æŸ¥ --> ç»‘å®šæˆåŠŸ : é”å®šæˆåŠŸ
    è®¾å¤‡é”å®šæ£€æŸ¥ --> ç»‘å®šå¤±è´¥ : é”å®šå¤±è´¥
    
    çŠ¶æ€æŸ¥è¯¢ç±» --> è®¾å¤‡é€šä¿¡
    è®¾å¤‡é€šä¿¡ --> çŠ¶æ€è§£æ
    çŠ¶æ€è§£æ --> æŸ¥è¯¢æˆåŠŸ
    çŠ¶æ€è§£æ --> æŸ¥è¯¢å¤±è´¥
    
    é€šä¿¡æ§åˆ¶ç±» --> è„šæœ¬æ‰§è¡Œå¼•æ“
    è„šæœ¬æ‰§è¡Œå¼•æ“ --> åŠ¨æ€ç¼–è¯‘
    åŠ¨æ€ç¼–è¯‘ --> æŒ‡ä»¤å‘é€
    æŒ‡ä»¤å‘é€ --> æ‰§è¡ŒæˆåŠŸ
    æŒ‡ä»¤å‘é€ --> æ‰§è¡Œå¤±è´¥
    
    æµç¨‹æ§åˆ¶ç±» --> æ¡ä»¶åˆ¤æ–­
    æ¡ä»¶åˆ¤æ–­ --> æ¡ä»¶æ»¡è¶³ : if_ok
    æ¡ä»¶åˆ¤æ–­ --> æ¡ä»¶ä¸æ»¡è¶³ : if_fail
    
    ç»‘å®šæˆåŠŸ --> [*]
    ç»‘å®šå¤±è´¥ --> é‡è¯•æœºåˆ¶
    æŸ¥è¯¢æˆåŠŸ --> [*]
    æŸ¥è¯¢å¤±è´¥ --> é‡è¯•æœºåˆ¶
    æ‰§è¡ŒæˆåŠŸ --> [*]
    æ‰§è¡Œå¤±è´¥ --> é‡è¯•æœºåˆ¶
    æ¡ä»¶æ»¡è¶³ --> [*]
    æ¡ä»¶ä¸æ»¡è¶³ --> [*]
    
    é‡è¯•æœºåˆ¶ --> æŒ‡ä»¤è§£æ : ç»§ç»­é‡è¯•
    é‡è¯•æœºåˆ¶ --> [*] : è¶…è¿‡é‡è¯•æ¬¡æ•°
```

---

## 3. å„æŒ‡ä»¤ç±»å‹è¯¦ç»†æ‰§è¡Œæœºåˆ¶åˆ†æ

### 3.1 è®¾å¤‡ç®¡ç†ç±»æŒ‡ä»¤æ·±åº¦è§£æ

#### 3.1.1 binding_by_status(11) - æ™ºèƒ½çŠ¶æ€ç»‘å®šæŒ‡ä»¤

**ä¸šåŠ¡åœºæ™¯**ï¼šæ ¹æ®è®¾å¤‡çŠ¶æ€æ™ºèƒ½é€‰æ‹©å¹¶ç»‘å®šæœ€ä¼˜è®¾å¤‡

```csharp
if (insTypeEnum == InstructTypeEnum.binding_by_status)
{
    // 1. æ£€æŸ¥å·²ç»‘å®šè®¾å¤‡
    DevUnitVo tmpLockDev = this.taskController.GetLockedDev(this.LockId, this.ScheduledVo, unit);
    if (tmpLockDev == null)
    {
        // 2. è·å–æœªé”å®šè®¾å¤‡åˆ—è¡¨
        List<DevUnitVo> tmpUnLockedList = this.taskController.GetUnLockedDevList(LockId, this.ScheduledVo, unit);
        if (tmpUnLockedList != null)
        {
            foreach (DevUnitVo d in tmpUnLockedList)
            {
                // 3. è·å–è®¾å¤‡é€šä¿¡æ¥å£
                DevComm devComm = this.taskController.GetDevComm(d);
                if (devComm != null)
                {
                    // 4. ç‰¹æ®Šä¸šåŠ¡é€»è¾‘ï¼šCNCæœºåºŠäº§å“åŒ¹é…æ£€æŸ¥
                    bool checkedDevPrd = true;
                    bool isJC = false;
                    if (d.DevMode?.DevCategory?.TypeName?.ToLower() == "cnc")
                    {
                        isJC = true;
                        if (d.ProductId > 0 && d.ProductId == ScheduledVo.TargetProductId)
                        {
                            // äº§å“åŒ¹é…ï¼Œç»§ç»­å¤„ç†
                            checkedDevPrd = true;
                        }
                        else
                        {
                            // äº§å“ä¸åŒ¹é…ï¼Œè·³è¿‡æ­¤è®¾å¤‡
                            checkedDevPrd = false;
                            unitResult.ResultFlag = CommResultFlag.Fail;
                        }
                    }
                    
                    if (checkedDevPrd)
                    {
                        // 5. æ‰§è¡Œè®¾å¤‡çŠ¶æ€æ£€æŸ¥
                        CommResult tmpResult = devComm.CommInterface.SendInfo(
                            MainTools.GetCommSendInfo(unit, lastResult, lastPersistent, msgId, 
                            this.ScheduledVo.Id, TaskInfo));
                        
                        // 6. çŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼Œå°è¯•é”å®šè®¾å¤‡
                        if (tmpResult.ResultFlag == CommResultFlag.Ok)
                        {
                            if (this.taskController.LockDevUnitVo(this.LockId, this.ScheduledVo, unit, d))
                            {
                                unitResult = tmpResult;
                                break; // é”å®šæˆåŠŸï¼Œè·³å‡ºå¾ªç¯
                            }
                            else
                            {
                                // é”å®šå¤±è´¥ï¼Œè®¾å¤‡å¯èƒ½è¢«å…¶ä»–ä»»åŠ¡å ç”¨
                                unitResult.ResultFlag = CommResultFlag.Fail;
                                unitResult.Msg = "æ²¡æœ‰ç»‘å®šè®¾å¤‡ï¼Œè®¾å¤‡å¯èƒ½åœ¨å…¶å®ƒä»»åŠ¡ä¸­å·²ç»‘å®š";
                            }
                        }
                    }
                }
            }
        }
    }
    else
    {
        // å·²ç»ç»‘å®šçš„è®¾å¤‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ
        unitResult.ResultFlag = StatusConst.CommResultFlag.Ok;
        unitResult.Msg = $"ä»»åŠ¡ï¼š{this.LockId} ç»‘å®šè®¾å¤‡ï¼š{tmpLockDev.Id}-{tmpLockDev.DevName}-{tmpLockDev.IpAddress}";
    }
}
```

**ç®—æ³•ç‰¹ç‚¹**ï¼š
1. **æ™ºèƒ½éå†**ï¼šè‡ªåŠ¨éå†æ‰€æœ‰æœªé”å®šè®¾å¤‡
2. **çŠ¶æ€éªŒè¯**ï¼šå®æ—¶æ£€æŸ¥è®¾å¤‡çŠ¶æ€æ˜¯å¦æ»¡è¶³æ¡ä»¶
3. **äº§å“åŒ¹é…**ï¼šCNCè®¾å¤‡ç‰¹æ®Šå¤„ç†ï¼Œç¡®ä¿äº§å“ä¸€è‡´æ€§
4. **åŸå­é”å®š**ï¼šç¡®ä¿è®¾å¤‡é”å®šçš„åŸå­æ€§æ“ä½œ
5. **å¤±è´¥æ¢å¤**ï¼šé”å®šå¤±è´¥æ—¶è‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªè®¾å¤‡

#### 3.1.2 binding_by_code(15) - ç²¾ç¡®ç¼–ç ç»‘å®šæŒ‡ä»¤

**ä¸šåŠ¡åœºæ™¯**ï¼šæŒ‰MQTTä»»åŠ¡ä¸­æŒ‡å®šçš„è®¾å¤‡ç¼–ç ç²¾ç¡®ç»‘å®šè®¾å¤‡

```csharp
else if (insTypeEnum == InstructTypeEnum.binding_by_code)
{
    // 1. ä»MQTTä»»åŠ¡ä¿¡æ¯ä¸­æå–è®¾å¤‡ç¼–ç 
    bool isPickUpCodeOk = false;
    bool isPickDownCodeOk = false;
    string mqPickUpCode = string.Empty;
    string mqPutDownCode = string.Empty;
    
    // 2. æ£€æŸ¥å–æ–™è®¾å¤‡ç¼–ç 
    if (dictTaskInfo.ContainsKey("mqPickUpCode"))
    {
        mqPickUpCode = dictTaskInfo["mqPickUpCode"];
        DevUnitVo tmpLockDev = this.taskController.GetDevUnitVoAndLockByCode(
            this.LockId, mqPickUpCode, this.ScheduledVo, unit, true);
        if (tmpLockDev != null)
        {
            isPickUpCodeOk = true;
        }
    }
    
    // 3. æ£€æŸ¥æ”¾æ–™è®¾å¤‡ç¼–ç ï¼ˆå¦‚æœå–æ–™å¤±è´¥ï¼‰
    if (!isPickUpCodeOk && dictTaskInfo.ContainsKey("mqPutDownCode"))
    {
        mqPutDownCode = dictTaskInfo["mqPutDownCode"];
        DevUnitVo tmpLockDev = this.taskController.GetDevUnitVoAndLockByCode(
            this.LockId, mqPutDownCode, this.ScheduledVo, unit, true);
        if (tmpLockDev != null)
        {
            isPickDownCodeOk = true;
        }
    }
    
    // 4. ç»“æœåˆ¤æ–­
    if (isPickUpCodeOk || isPickDownCodeOk)
    {
        unitResult.ResultFlag = StatusConst.CommResultFlag.Ok;
        unitResult.Msg = $"ä»»åŠ¡ï¼š{this.LockId} ç»‘å®šè®¾å¤‡æˆåŠŸ";
    }
    else
    {
        // 5. ç»‘å®šå¤±è´¥å¤„ç†
        if (IsNeedPause())
        {
            unitResult.ResultFlag = CommResultFlag.Fail;
            unitResult.AlarmFlag = StatusConst.CommResultFlag.Alarm;
        }
        else
        {
            unitResult.ResultFlag = CommResultFlag.Finished;
            unitResult.AlarmFlag = StatusConst.CommResultFlag.Alarm;
        }
        unitResult.Msg = $"ä»»åŠ¡ï¼š{this.LockId} ç»‘å®šè®¾å¤‡å¤±è´¥ mqPickUpCode {mqPickUpCode} mqPutDownCode {mqPutDownCode}";
    }
}
```

**ç®—æ³•ç‰¹ç‚¹**ï¼š
1. **ç²¾ç¡®åŒ¹é…**ï¼šæŒ‰è®¾å¤‡ç¼–ç ç²¾ç¡®æŸ¥æ‰¾å’Œç»‘å®š
2. **å¤šç¼–ç æ”¯æŒ**ï¼šæ”¯æŒå–æ–™ç¼–ç å’Œæ”¾æ–™ç¼–ç ä¸¤ç§æ¨¡å¼
3. **ä¼˜å…ˆçº§å¤„ç†**ï¼šä¼˜å…ˆå¤„ç†å–æ–™ç¼–ç ï¼Œå¤±è´¥åå°è¯•æ”¾æ–™ç¼–ç 
4. **MQTTé›†æˆ**ï¼šä¸MQTTä»»åŠ¡ä¿¡æ¯æ·±åº¦é›†æˆ
5. **é”™è¯¯ç­–ç•¥**ï¼šç»‘å®šå¤±è´¥æ—¶æ ¹æ®é…ç½®é€‰æ‹©æš‚åœæˆ–ç»“æŸ

### 3.2 çŠ¶æ€æŸ¥è¯¢ç±»æŒ‡ä»¤æ·±åº¦è§£æ

#### 3.2.1 dev_pos(12) - è®¾å¤‡ä½ç½®è·å–æŒ‡ä»¤

**ä¸šåŠ¡åœºæ™¯**ï¼šè·å–ç»‘å®šè®¾å¤‡çš„ä½ç½®ä¿¡æ¯ï¼Œç”¨äºAGVå¯¼èˆª

```csharp
else if (insTypeEnum == InstructTypeEnum.dev_pos)
{
    // 1. è·å–å·²ç»‘å®šçš„è®¾å¤‡
    DevUnitVo dev = this.taskController.GetDevUnitVoAndLock(this.LockId, this.ScheduledVo, unit, false);
    if (dev == null)
    {
        // 2. è®¾å¤‡æœªæ‰¾åˆ°å¤„ç†
        unitResult.Msg = "æ²¡æœ‰æ‰¾åˆ°ç»‘å®šçš„è®¾å¤‡";
        unitResult.ResultFlag = StatusConst.CommResultFlag.Comm_Mode_Err;
        unitResult.AlarmFlag = StatusConst.CommResultFlag.Alarm;
        unitResult.ResultFlag = CommResultFlag.Ok;
        unitResult.ResultValue = "-99"; // ç‰¹æ®Šé”™è¯¯æ ‡è¯†
    }
    else
    {
        // 3. æ£€æŸ¥è®¾å¤‡ä½ç½®æ•°æ®
        if (string.IsNullOrEmpty(dev.DevAliases))
        {
            unitResult = new CommResult() { 
                ResultFlag = CommResultFlag.Fail, 
                Msg = "è®¾å¤‡ä½ç½®æ•°æ®ä¸ºç©º" 
            };
            unitResult.AlarmFlag = StatusConst.CommResultFlag.Alarm;
            unitResult.ResultFlag = CommResultFlag.Ok;
            unitResult.ResultValue = "-99";
        }
        else
        {
            // 4. è¿”å›è®¾å¤‡ä½ç½®ä¿¡æ¯
            unitResult = new CommResult() { 
                ResultFlag = CommResultFlag.Ok, 
                ResultValue = dev.DevAliases 
            };
        }
    }
}
```

#### 3.2.2 dev_coords(14) - è®¾å¤‡åæ ‡è·å–æŒ‡ä»¤

**ä¸šåŠ¡åœºæ™¯**ï¼šè·å–è®¾å¤‡çš„è¯¦ç»†åæ ‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬åæ ‡ã€æ–¹å‘ã€ç¼–ç ç­‰

```csharp
else if (insTypeEnum == InstructTypeEnum.dev_coords)
{
    DevUnitVo dev = this.taskController.GetDevUnitVoAndLock(this.LockId, this.ScheduledVo, unit, false);
    if (dev == null)
    {
        unitResult.Msg = "æ²¡æœ‰æ‰¾åˆ°ç»‘å®šçš„è®¾å¤‡";
        unitResult.ResultFlag = StatusConst.CommResultFlag.Comm_Mode_Err;
        unitResult.AlarmFlag = StatusConst.CommResultFlag.Alarm;
        unitResult.ResultFlag = CommResultFlag.Ok;
        unitResult.ResultValue = "-99";
    }
    else
    {
        // æ„å»ºè®¾å¤‡åæ ‡ä¿¡æ¯å­—å…¸
        Dictionary<string, string> dict = new Dictionary<string, string>();
        dict.Add("coords", dev.AreaCoords);    // åŒºåŸŸåæ ‡
        dict.Add("dir", dev.AreaDir);          // æ–¹å‘ä¿¡æ¯
        dict.Add("devCode", dev.DevCode);      // è®¾å¤‡ç¼–ç 
        dict.Add("devId", dev.Id.ToString()); // è®¾å¤‡ID
        
        string str = FileIOTools.SerializeObject(dict);
        unitResult = new CommResult() { 
            ResultFlag = CommResultFlag.Ok, 
            ResultValue = str 
        };
    }
}
```

### 3.3 æµç¨‹æ§åˆ¶ç±»æŒ‡ä»¤æ·±åº¦è§£æ

#### 3.3.1 condition_if(2) - æ¡ä»¶åˆ¤æ–­æŒ‡ä»¤

**ä¸šåŠ¡åœºæ™¯**ï¼šæ‰§è¡Œæ¡ä»¶é€»è¾‘åˆ¤æ–­ï¼Œæ§åˆ¶å·¥åºæµç¨‹åˆ†æ”¯

```csharp
else if (insTypeEnum == InstructTypeEnum.condition_if)
{
    if (unit.DevModeId <= 0)
    {
        // 1. æ— è®¾å¤‡æ¨¡å¼ï¼šä½¿ç”¨è„šæœ¬å¼•æ“æ‰§è¡Œæ¡ä»¶åˆ¤æ–­
        ICommInterface comm = CommunicationHelper.GetEmptyComm(
            this.taskController.MainController.SysCfgInfo.EmptyDevClass);
        if (comm != null)
        {
            unitResult = comm.SendInfo(MainTools.GetCommSendInfo(
                unit, lastResult, lastPersistent, msgId, this.ScheduledVo.Id, TaskInfo));
        }
    }
    else
    {
        // 2. æœ‰è®¾å¤‡æ¨¡å¼ï¼šé€šè¿‡è®¾å¤‡æ¥å£æ‰§è¡Œæ¡ä»¶åˆ¤æ–­
        // (å…·ä½“å®ç°å¯æ‰©å±•è®¾å¤‡ç›¸å…³çš„æ¡ä»¶åˆ¤æ–­é€»è¾‘)
    }
}
```

**æ¡ä»¶åˆ¤æ–­ç»“æœç±»å‹**ï¼š
- `CommResultFlag.If_Ok` - æ¡ä»¶æ»¡è¶³ï¼Œæ‰§è¡Œå­æŒ‡ä»¤é›†
- `CommResultFlag.If_Fail` - æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡å­æŒ‡ä»¤é›†

### 3.4 é€šä¿¡æ§åˆ¶ç±»æŒ‡ä»¤æ·±åº¦è§£æ

#### 3.4.1 http_req(13) - HTTPè¯·æ±‚æŒ‡ä»¤

**ä¸šåŠ¡åœºæ™¯**ï¼šæ‰§è¡ŒHTTP APIè°ƒç”¨ï¼Œä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆ

```csharp
else if (insTypeEnum == InstructTypeEnum.http_req)
{
    // 1. è·å–HTTPé€šä¿¡æ¥å£
    ICommInterface comm = CommunicationHelper.GetCommInterfaceByCommMode(
        ((int)CommMode.HTTP).ToString());

    if (comm != null)
    {
        // 2. è®¾ç½®é€šä¿¡æ¥å£å‚æ•°
        comm.MainController = taskController.MainController;
        comm.RegEasyLogger(taskController.MainController.LoggerAction);
        
        // 3. å‡†å¤‡ä»»åŠ¡ä¿¡æ¯
        string tmpInfo = TaskInfo;
        if (comm.Dev != null)
        {
            tmpInfo = GetTaskInfoByDev(comm.Dev);
        }
        
        // 4. æ‰§è¡ŒHTTPè¯·æ±‚
        unitResult = comm.SendInfo(MainTools.GetCommSendInfo(
            unit, lastResult, lastPersistent, msgId, this.ScheduledVo.Id, tmpInfo));
    }
}
```

#### 3.4.2 normal(10) - æ™®é€šé€šä¿¡æŒ‡ä»¤

**ä¸šåŠ¡åœºæ™¯**ï¼šæ ‡å‡†è®¾å¤‡é€šä¿¡ï¼Œæ”¯æŒå¤šç§é€šä¿¡åè®®

```csharp
else // normalç±»å‹æˆ–å…¶ä»–é€šä¿¡æŒ‡ä»¤
{
    if (unit.DevModeId <= 0)
    {
        // 1. æ— è®¾å¤‡æ¨¡å¼ï¼šä½¿ç”¨ç©ºè®¾å¤‡é€šä¿¡æ¥å£
        ICommInterface comm = CommunicationHelper.GetEmptyComm(
            this.taskController.MainController.SysCfgInfo.EmptyDevClass);
        if (comm != null)
        {
            comm.MainController = taskController.MainController;
            
            // 2. å‡†å¤‡ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–‡ä¿¡æ¯
            if (dictTaskInfo.ContainsKey("CurIdx"))
            {
                dictTaskInfo["CurIdx"] = curIdx.ToString();
            }
            else
            {
                dictTaskInfo.Add("CurIdx", curIdx.ToString());
            }

            // 3. æ·»åŠ å¾ªç¯æ§åˆ¶ä¿¡æ¯
            if (dictTaskInfo.ContainsKey("LoopFlag"))
            {
                dictTaskInfo["LoopFlag"] = unit.LoopFlag.ToString();
            }
            else
            {
                dictTaskInfo.Add("LoopFlag", unit.LoopFlag.ToString());
            }
            
            // 4. æ·»åŠ è¶…æ—¶æ§åˆ¶ä¿¡æ¯
            if (unit.LoopFlag == 1)
            {
                dictTaskInfo.AddOrUpdate("LoopTimeOut", unit.TimeOut.ToString());
                dictTaskInfo.AddOrUpdate("LastTicks", lastTicks.ToString());
            }
            
            // 5. åºåˆ—åŒ–ä»»åŠ¡ä¿¡æ¯å¹¶æ‰§è¡Œ
            string tmpTaskInfo = FileIOTools.SerializeObject(dictTaskInfo);
            unitResult = comm.SendInfo(MainTools.GetCommSendInfo(
                unit, lastResult, lastPersistent, msgId, this.ScheduledVo.Id, tmpTaskInfo));
        }
    }
    else
    {
        // 6. æœ‰è®¾å¤‡æ¨¡å¼ï¼šä½¿ç”¨è®¾å¤‡é€šä¿¡æ¥å£
        DevUnitVo dev = this.taskController.GetDevUnitVoAndLock(this.LockId, this.ScheduledVo, unit, false);
        if (dev == null)
        {
            unitResult.Msg = "æ²¡æœ‰æ‰¾åˆ°ç»‘å®šçš„è®¾å¤‡";
            unitResult.ResultFlag = StatusConst.CommResultFlag.Comm_Mode_Err;
        }
        else
        {
            DevComm devComm = this.taskController.GetDevComm(dev);
            if (devComm == null)
            {
                unitResult.Msg = "é€šè¿…æ¥å£æ¨¡å—æœªæ‰¾åˆ°";
                unitResult.ResultFlag = StatusConst.CommResultFlag.Comm_Mode_Err;
            }
            else
            {
                // 7. æ‰§è¡Œè®¾å¤‡é€šä¿¡
                unitResult = devComm.CommInterface.SendInfo(MainTools.GetCommSendInfo(
                    unit, lastResult, lastPersistent, msgId, this.ScheduledVo.Id, TaskInfo));
            }
        }
    }
}
```

---

## 4. Wu-AGV ä¸šåŠ¡æŒ‡ä»¤ç±»å‹æ˜ å°„

### 4.1 Wu-AGV 8ç±»ä»»åŠ¡ä¸æŒ‡ä»¤ç±»å‹æ˜ å°„

| Wu-AGVä»»åŠ¡ç±»å‹ | å¯¹åº”æŒ‡ä»¤åºåˆ— | ä¸»è¦æŒ‡ä»¤ç±»å‹ | ä¸šåŠ¡åŠŸèƒ½ |
|---------------|-------------|-------------|----------|
| **dispenser_move** | binding_by_code â†’ move â†’ dev_pos | move(5) | AGVç§»åŠ¨åˆ°åˆ†æ¶²å°ä½ç½® |
| **dispenser_pickup** | binding_by_code â†’ action â†’ status_get | action(4) | ä»åˆ†æ¶²å°å–æ · |
| **transfer_move** | binding_by_code â†’ move â†’ dev_coords | move(5) | AGVç§»åŠ¨åˆ°ä¸­è½¬å° |
| **transfer_delivery** | binding_by_code â†’ action â†’ normal | action(4) | å‘ä¸­è½¬å°æŠ•æ–™ |
| **transfer_pickup** | binding_by_status â†’ action â†’ condition_if | action(4) | ä»ä¸­è½¬å°å–æ–™ |
| **analyzer_delivery** | binding_by_status â†’ action â†’ http_req | action(4) | å‘åˆ†æä»ªæŠ•æ–™ |
| **analyzer_pickup** | binding_by_status â†’ status_get â†’ action | action(4) | ä»åˆ†æä»ªå–æ–™ |
| **waste_delivery** | binding_by_code â†’ action â†’ finished | action(4) | åºŸæ–™æŠ•æ”¾å¤„ç† |

### 4.2 ä¸šåŠ¡æŒ‡ä»¤ç»„åˆæ¨¡å¼

```csharp
// å…¸å‹çš„Wu-AGVä»»åŠ¡å·¥åºç»„åˆç¤ºä¾‹
InstructCombinationVo dispenserPickupCombo = new InstructCombinationVo
{
    CombinationName = "dispenser_pickup",
    DisplayName = "åˆ†æ¶²å°å–æ ·",
    InstructUnitList = new List<InstructUnitVo>
    {
        new InstructUnitVo // 1. æŒ‰ç¼–ç ç»‘å®šåˆ†æ¶²å°è®¾å¤‡
        {
            InstructName = "ç»‘å®šåˆ†æ¶²å°",
            InsType = InstructTypeEnum.binding_by_code,
            OrderNum = 1
        },
        new InstructUnitVo // 2. æ‰§è¡Œå–æ ·åŠ¨ä½œ
        {
            InstructName = "æ‰§è¡Œå–æ ·",
            InsType = InstructTypeEnum.action,
            OrderNum = 2,
            ExecuteScriptType = 1, // ä½¿ç”¨C#è„šæœ¬
            InstructContent = @"
                public string MyMethod(string parm, string persistent, string taskInfo)
                {
                    // è§£æMQTTä»»åŠ¡ä¿¡æ¯
                    var taskData = JsonConvert.DeserializeObject<Dictionary<string, object>>(taskInfo);
                    string sampleId = taskData[""mqSampleId""].ToString();
                    string slotId = taskData[""mqPickUpSlot""].ToString();
                    
                    // æ„å»ºå–æ ·æŒ‡ä»¤
                    var pickupCmd = new
                    {
                        command = ""pickup_sample"",
                        sample_id = sampleId,
                        slot_id = slotId,
                        timestamp = DateTime.Now.ToString(""yyyy-MM-dd HH:mm:ss"")
                    };
                    
                    return JsonConvert.SerializeObject(pickupCmd);
                }"
        },
        new InstructUnitVo // 3. éªŒè¯å–æ ·ç»“æœ
        {
            InstructName = "éªŒè¯å–æ ·",
            InsType = InstructTypeEnum.condition_if,
            OrderNum = 3,
            CheckFlag = 1,
            CheckScriptType = 1,
            CheckContent = @"
                public string MyMethod(string result, string persistent, string taskInfo)
                {
                    var resultData = JsonConvert.DeserializeObject<Dictionary<string, object>>(result);
                    string status = resultData[""status""].ToString();
                    
                    if (status == ""success"")
                    {
                        return JsonConvert.SerializeObject(new { code = 1, result = ""å–æ ·æˆåŠŸ"" });
                    }
                    else
                    {
                        return JsonConvert.SerializeObject(new { code = 0, result = ""å–æ ·å¤±è´¥"" });
                    }
                }"
        }
    }
};
```

---

## 5. è„šæœ¬æ‰§è¡Œå¼•æ“æ·±åº¦é›†æˆ

### 5.1 ä¸‰ç§è„šæœ¬ç±»å‹æ”¯æŒ

```csharp
/// <summary>
/// æŒ‡ä»¤å†…å®¹ç±»å‹ï¼š
/// 0: å‘é€å†…å®¹(ç›´æ¥å†…å®¹)
/// 1: C#å‡½æ•°è„šæœ¬(åŠ¨æ€ç¼–è¯‘) 
/// 2: å‰ç½®ç»“æœå†…å®¹(æ•°æ®ä¼ é€’)
/// </summary> 
public int ExecuteScriptType { get; set; }

/// <summary>
/// æŒ‡ä»¤æ ¡éªŒç±»å‹ï¼š
/// 0: ç»“æœæ ¡éªŒå†…å®¹
/// 1: C#å‡½æ•°è„šæœ¬(æ ¡éªŒé€»è¾‘åŠ¨æ€ç¼–è¯‘)
/// </summary>
public int CheckScriptType { get; set; }
```

### 5.2 è„šæœ¬æ‰§è¡Œæµç¨‹

```csharp
// åœ¨AbstractCommåŸºç±»ä¸­çš„è„šæœ¬æ‰§è¡Œé€»è¾‘
int insScript = sendInfo.InstructUnit.ExecuteScriptType;

if (insScript == 1 && !string.IsNullOrEmpty(insContent))
{
    // åŠ¨æ€C#è„šæœ¬æ‰§è¡Œ
    ScriptResult scriptResult = ScriptExecuteTools.ScriptCompile(
        lastResult,                    // ä¸Šæ¬¡æ‰§è¡Œç»“æœ
        lastPersStr,                   // æŒä¹…åŒ–æ•°æ®  
        insContent,                    // è„šæœ¬å†…å®¹
        sendInfo.TaskInfo,             // ä»»åŠ¡ä¸Šä¸‹æ–‡
        sendInfo.InstructUnit.Id,      // æŒ‡ä»¤ID
        0                              // æ‰§è¡Œç±»å‹(0=æ‰§è¡Œ, 1=æ ¡éªŒ)
    );
    
    if (scriptResult.Code == 1)
    {
        insContent = scriptResult.Result; // ä½¿ç”¨è„šæœ¬æ‰§è¡Œç»“æœ
    }
}
```

### 5.3 è„šæœ¬ä¸Šä¸‹æ–‡ä¿¡æ¯

**ä¼ é€’ç»™è„šæœ¬çš„ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼š
1. **lastResult** - å‰ä¸€æŒ‡ä»¤çš„æ‰§è¡Œç»“æœ
2. **lastPersistent** - æŒä¹…åŒ–ä¿å­˜çš„æ•°æ®
3. **TaskInfo** - å½“å‰ä»»åŠ¡çš„å®Œæ•´ä¿¡æ¯
4. **InstructUnit** - å½“å‰æŒ‡ä»¤çš„è¯¦ç»†ä¿¡æ¯
5. **ScheduledId** - è°ƒåº¦ä»»åŠ¡ID

---

## 6. æŒ‡ä»¤æ‰§è¡Œæ€§èƒ½ä¼˜åŒ–æœºåˆ¶

### 6.1 å¾ªç¯é‡è¯•æ§åˆ¶

```csharp
// æ™ºèƒ½é‡è¯•æœºåˆ¶
bool isLoopFlag = unit.LoopFlag == 1;
if (isLoopFlag && loopCtr && (unitResult.ResultFlag != CommResultFlag.Alarm 
    && unitResult.ResultFlag != CommResultFlag.If_Fail))
{
    // 1. è®¡ç®—é‡è¯•é—´éš”
    int retryInterval = unit.IntervalTimes < 100 ? 100 : unit.IntervalTimes;
    Thread.Sleep(retryInterval);
    
    // 2. è®°å½•é‡è¯•äº‹ä»¶
    taskController.FireEventMainController(new CTaskEvent()
    {
        EventType = CEventType.Noraml_Err,
        EventName = $"æŒ‡ä»¤é‡è¯•: {unitResult.Msg}",
        EventResult = unitResult,
        InstructUnit = unit,
        TaskSubId = this.LockId
    });
    
    // 3. ç»§ç»­ä¸‹ä¸€æ¬¡é‡è¯•
    continue;
}
```

### 6.2 è¶…æ—¶æ§åˆ¶æœºåˆ¶

```csharp
// æŒ‡ä»¤çº§è¶…æ—¶æ§åˆ¶
int timeOut = unit.TimeOut;
DateTime lastDt = DateTime.Now;
long lastTicks = lastDt.Ticks;

// åœ¨å¾ªç¯ä¸­æ£€æŸ¥è¶…æ—¶
if (unit.LoopFlag == 1 && timeOut > 0)
{
    long currentTicks = DateTime.Now.Ticks;
    long elapsedMs = (currentTicks - lastTicks) / TimeSpan.TicksPerMillisecond;
    
    if (elapsedMs > timeOut)
    {
        unitResult.ResultFlag = CommResultFlag.Fail;
        unitResult.Msg = $"æŒ‡ä»¤æ‰§è¡Œè¶…æ—¶ï¼Œå·²æ‰§è¡Œ{elapsedMs}æ¯«ç§’ï¼Œè¶…æ—¶é˜ˆå€¼{timeOut}æ¯«ç§’";
        break;
    }
}
```

### 6.3 çŠ¶æ€æŒä¹…åŒ–æœºåˆ¶

```csharp
// æŒä¹…åŒ–æ ‡å¿—å¤„ç†
if (unit.PersistentFlag == 1)
{
    lastPersistent = unitResult; // ä¿å­˜ä¸ºæŒä¹…åŒ–ç»“æœ
}

// æ¢å¤ç‚¹æ ‡è®°
if (unit.ResumeFlag == 1)
{
    ResumeUnit = unit; // ä¿å­˜æœ€è¿‘çš„æ¢å¤ç‚¹
}
```

---

## æ€»ç»“

SchedAppCoreçš„å·¥åºæ‰§è¡Œä¸æŒ‡ä»¤ç±»å‹ä½“ç³»ä»£è¡¨äº†å·¥ä¸šè‡ªåŠ¨åŒ–è°ƒåº¦ç³»ç»Ÿåœ¨æŒ‡ä»¤è®¾è®¡å’Œæ‰§è¡Œæœºåˆ¶ä¸Šçš„å…ˆè¿›å®è·µã€‚é€šè¿‡20ç§ä¸åŒæŒ‡ä»¤ç±»å‹çš„ç²¾ç»†åˆ†å·¥ï¼Œé…åˆå¼ºå¤§çš„è„šæœ¬æ‰§è¡Œå¼•æ“å’Œå®Œå–„çš„ç›‘æ§æœºåˆ¶ï¼Œç³»ç»Ÿå®ç°äº†ä»ç®€å•è®¾å¤‡æ§åˆ¶åˆ°å¤æ‚ä¸šåŠ¡æµç¨‹çš„å…¨è¦†ç›–ã€‚

**æ ¸å¿ƒæŠ€æœ¯ä»·å€¼**ï¼š
1. **æŒ‡ä»¤ç±»å‹å®Œå¤‡æ€§**ï¼šè¦†ç›–è®¾å¤‡ç®¡ç†ã€çŠ¶æ€æŸ¥è¯¢ã€æµç¨‹æ§åˆ¶ã€é€šä¿¡äº¤äº’ç­‰æ‰€æœ‰ä¸šåŠ¡åœºæ™¯
2. **æ‰§è¡Œå¼•æ“é«˜æ•ˆæ€§**ï¼šä¼˜åŒ–çš„å¾ªç¯é‡è¯•ã€è¶…æ—¶æ§åˆ¶ã€çŠ¶æ€æŒä¹…åŒ–æœºåˆ¶
3. **è„šæœ¬é›†æˆçµæ´»æ€§**ï¼šæ”¯æŒC#åŠ¨æ€ç¼–è¯‘ã€ç»“æœéªŒè¯ã€ä¸Šä¸‹æ–‡ä¼ é€’
4. **ç›‘æ§è°ƒè¯•å®Œæ•´æ€§**ï¼šå…¨æµç¨‹äº‹ä»¶è·Ÿè¸ªã€çŠ¶æ€è®°å½•ã€é”™è¯¯æ¢å¤

è¯¥æŒ‡ä»¤æ‰§è¡Œä½“ç³»ä¸ºæ™ºèƒ½åˆ¶é€ ã€å®éªŒå®¤è‡ªåŠ¨åŒ–ç­‰é¢†åŸŸçš„å¤æ‚è°ƒåº¦éœ€æ±‚æä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ï¼Œå…·æœ‰å¾ˆé«˜çš„å­¦ä¹ å’Œå‚è€ƒä»·å€¼ã€‚ 